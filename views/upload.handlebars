<div class="container">
  <div class="nav">
    <a href="/data" class="nav-link">Просмотр файлов</a>

    <button class="nav-link" id="logout">Выйти</button>
  </div>
  <h1 class="title">Загрузка CSV файла</h1>
  <div class="upload-area" id="uploadArea">
    <p id="uploadAreaText">Перетащите файл сюда или кликните для выбора</p>
    <input type="file" id="fileInput" class="file-input" accept=".csv" />
  </div>
  <button class="btn btn-primary" id="uploadBtn">Загрузить</button>
  <div id="loadingIndicator" class="loading-indicator" style="display: none;">
    <div class="spinner"></div>
    <p>Отправка файла на сервер...</p>
  </div>
</div>

<style>
  .loading-indicator {
    margin-top: 20px;
    text-align: center;
    color: #555;
  }

  .spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top: 4px solid #3498db;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const uploadArea = document.getElementById('uploadArea');
    const uploadAreaText = document.getElementById('uploadAreaText');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // Обработка клика по области загрузки
    uploadArea.addEventListener('click', () => fileInput.click());

    // Обработка изменения выбранного файла
    fileInput.addEventListener('change', handleFileSelection);

    // Обработка нажатия кнопки загрузки
    uploadBtn.addEventListener('click', handleFileUpload);

    // Drag and Drop функционал
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');

      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelection();
      }
    });

    function handleFileSelection() {
      if (fileInput.files.length === 0) return;

      const file = fileInput.files[0];
      uploadAreaText.textContent = file.name;
    }

    async function handleFileUpload() {
      try {
        if (fileInput.files.length === 0) {
          alert('Пожалуйста, выберите файл');
          return;
        }

        // Показываем индикатор загрузки
        loadingIndicator.style.display = 'block';
        uploadBtn.disabled = true;

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.status === "success") {
          alert('Файл будет загружен в ближайшее время');
          resetFileInput();
          return;
        }

        throw new Error('Ошибка сервера при загрузке файла');
      } catch (error) {
        console.error('Ошибка загрузки:', error);
        alert('Ошибка при загрузке файла');
      } finally {
        // Скрываем индикатор загрузки в любом случае
        loadingIndicator.style.display = 'none';
        uploadBtn.disabled = false;
      }
    }

    function resetFileInput() {
      fileInput.value = '';
      uploadAreaText.textContent = 'Перетащите файл сюда или кликните для выбора';
    }
  });
</script>

<script>
  document.getElementById('logout').addEventListener('click', function () {
    fetch('/logout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    })
      .then(response => {
        if (response.ok) {
          window.location.href = '/login';
        }
      })
      .catch(error => {
        console.error('Ошибка при выходе:', error);
      });
  });
</script>